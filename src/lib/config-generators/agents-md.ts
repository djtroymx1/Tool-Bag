import { groupBy } from "@/lib/utils";
import type { CatalogItem } from "@/types/catalog";

export function generateAgentsMd(items: CatalogItem[]): string {
  const lines: string[] = [];

  lines.push("# AGENTS.md");
  lines.push("");
  lines.push("> Generated by Tool Bag â€” https://toolbag-sigma.vercel.app");
  lines.push("");

  const grouped = groupBy(items, "category");

  for (const [category, categoryItems] of Object.entries(grouped)) {
    lines.push(`## ${category}`);
    lines.push("");

    for (const item of categoryItems) {
      lines.push(`### ${item.name}`);
      lines.push("");
      lines.push(item.description);
      lines.push("");

      if (
        item.codex_install &&
        item.codex_install !== "Bookmark" &&
        item.codex_install !== "Bookmark (many items cross-compatible)" &&
        item.codex_install !== "Adapt principles to AGENTS.md" &&
        item.codex_install !== "Reference for skill creation" &&
        item.codex_install !== "Visit registry"
      ) {
        lines.push("**Install:**");
        lines.push("```");
        lines.push(item.codex_install);
        lines.push("```");
        lines.push("");
      }

      if (item.url) {
        lines.push(`- [Documentation](${item.url})`);
        lines.push("");
      }
    }
  }

  // Tool activation rules section
  const itemsWithHints = items.filter((item) => item.activation_hint);
  if (itemsWithHints.length > 0) {
    lines.push("## Tool Activation Rules");
    lines.push("");
    lines.push(
      "These rules tell you WHEN and HOW to use each tool. Follow them proactively."
    );
    lines.push(
      "Do not wait for the user to ask you to use a tool. If a rule applies, use the tool."
    );
    lines.push("");

    for (const item of itemsWithHints) {
      lines.push(`### ${item.name}`);
      lines.push(item.activation_hint!);
      lines.push("");
    }
  }

  return lines.join("\n");
}
